name: Build and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        run: |
          gh release create Release --title "Release" --notes "Release" --draft || true
        env:
          GH_TOKEN: ${{ github.token }}

  build:
    needs: create-release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [linux, darwin]
        arch: [amd64, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
      - name: Download Assets
        run: make assets
      - name: Build Binary
        run: |
          VERSION=$(make version)
          make build GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} VERSION=${VERSION}
      - name: Upload Release Asset
        run: |
          gh release upload Release "nits-${{ matrix.os }}-${{ matrix.arch }}" --clobber
        env:
          GH_TOKEN: ${{ github.token }}

  publish:
    needs: [create-release, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Publish Release
        run: |
          gh release edit Release --draft=false
        env:
          GH_TOKEN: ${{ github.token }}
